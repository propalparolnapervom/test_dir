name: Auto Approve Workflow

on: 
  pull_request:
    paths:
      - 'dir1/**'
      - 'dir2/**'
    types:
      - opened
      - edited
      - reopened

jobs:
  verify_modified_files_job:
    runs-on: ubuntu-latest
    steps:
    - name: Verify Modified Files Step
      run: |
          # List of the dirs, modifications of which could be Automatically Approved
          #   LIST_OF_ONLY_DIRS_TO_BE_MODIFIED="dir1 dir2 dir3 ..."
          LIST_OF_ONLY_DIRS_TO_BE_MODIFIED="dir1 dir2"

          # This is updated to "yes" when all modified files are within one of dirs, modifications of which could be Automatically Approved
          FILES_IN_ONE_OF_ALLOWED_DIR="no"

          echo
          echo
          echo  " List of files that were modified outside of one of \"$LIST_OF_ONLY_DIRS_TO_BE_MODIFIED\" dir(s):"
          echo

          for allowed_dir in $LIST_OF_ONLY_DIRS_TO_BE_MODIFIED
          do
            if 
              curl --request GET \
              --url https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }}/files \
              --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' | \
              grep filename | \
              grep -v ${allowed_dir}
            then
              echo
            else
              FILES_IN_ONE_OF_ALLOWED_DIR=yes
            fi
          done

          if [ "${FILES_IN_ONE_OF_ALLOWED_DIR}" = "yes" ]
          then
            echo
            echo
            echo
            echo "  CONFIRMED: PR can be Auto Approved, as files from the list above are within one of the dirs from the  \"$LIST_OF_ONLY_DIRS_TO_BE_MODIFIED\" dir(s) list."
            echo
          else
            echo
            echo
            echo
            echo "  ERROR: PR can not be Auto Approved, as files from the list above are outside of each dir from \"$LIST_OF_ONLY_DIRS_TO_BE_MODIFIED\" dir(s) list."
            echo
            exit 8
          fi

  autoapprove_job:
    needs: verify_modified_files_job
    runs-on: ubuntu-latest
    steps:
    - name: Auto Approve Step
      uses: hmarr/auto-approve-action@v2.0.0
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"




